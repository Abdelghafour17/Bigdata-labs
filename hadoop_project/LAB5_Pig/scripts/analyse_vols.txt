--Top 20 Aéroports par Volume


-- Charger les données
flights = LOAD 'input/flights/sample_flights.csv' 
    USING PigStorage(',') 
    AS (
        year:int, month:int, day:int, day_of_week:int,
        dep_time:int, crs_dep_time:int, arr_time:int, crs_arr_time:int,
        carrier:chararray, flight_num:int, tail_num:chararray,
        actual_elapsed_time:int, crs_elapsed_time:int, air_time:int,
        arr_delay:int, dep_delay:int,
        origin:chararray, dest:chararray,
        distance:int, taxi_in:int, taxi_out:int,
        cancelled:int, cancellation_code:chararray, diverted:int,
        carrier_delay:int, weather_delay:int, nas_delay:int,
        security_delay:int, late_aircraft_delay:int
    );

-- Filtrer les vols non annulés et enlever l'en-tête
valid_flights = FILTER flights BY cancelled == 0 AND year IS NOT NULL;

-- ============================================
-- PARTIE 1 : Vols Sortants (Départs)
-- ============================================

departures = FOREACH valid_flights GENERATE origin AS airport;
dep_grouped = GROUP departures BY airport;
dep_counts = FOREACH dep_grouped GENERATE 
    group AS airport,
    COUNT(departures) AS dep_count;

-- ============================================
-- PARTIE 2 : Vols Entrants (Arrivées)
-- ============================================

arrivals = FOREACH valid_flights GENERATE dest AS airport;
arr_grouped = GROUP arrivals BY airport;
arr_counts = FOREACH arr_grouped GENERATE 
    group AS airport,
    COUNT(arrivals) AS arr_count;

-- ============================================
-- PARTIE 3 : Combiner et Calculer le Total
-- ============================================

-- Jointure externe complète (FULL OUTER)
airport_traffic = JOIN dep_counts BY airport FULL OUTER, arr_counts BY airport;

-- Calculer le volume total
airport_volumes = FOREACH airport_traffic GENERATE 
    (dep_counts::airport IS NOT NULL ? dep_counts::airport : arr_counts::airport) AS airport,
    (dep_counts::dep_count IS NOT NULL ? dep_counts::dep_count : 0L) AS departures,
    (arr_counts::arr_count IS NOT NULL ? arr_counts::arr_count : 0L) AS arrivals,
    ((dep_counts::dep_count IS NOT NULL ? dep_counts::dep_count : 0L) + 
     (arr_counts::arr_count IS NOT NULL ? arr_counts::arr_count : 0L)) AS total_flights;

-- Trier par volume total décroissant
sorted_airports = ORDER airport_volumes BY total_flights DESC;

-- Prendre le top 20
top20_airports = LIMIT sorted_airports 20;

-- Afficher les résultats
DUMP top20_airports;

-- Sauvegarder
STORE top20_airports INTO 'pigout/flights/top20_airports' USING PigStorage(',');

-- ============================================
-- VARIATION : Par Année
-- ============================================

-- Vols par aéroport et année
flights_by_year_origin = FOREACH valid_flights GENERATE year, origin AS airport;
flights_by_year_dest = FOREACH valid_flights GENERATE year, dest AS airport;

-- Combiner origine et destination
all_flights_by_year = UNION flights_by_year_origin, flights_by_year_dest;

-- Grouper par année et aéroport
grouped_by_year_airport = GROUP all_flights_by_year BY (year, airport);

-- Compter
volume_by_year = FOREACH grouped_by_year_airport GENERATE 
    FLATTEN(group) AS (year, airport),
    COUNT(all_flights_by_year) AS flight_count;

-- Trier
sorted_by_year = ORDER volume_by_year BY year, flight_count DESC;

-- Sauvegarder
STORE sorted_by_year INTO 'pigout/flights/airports_by_year' USING PigStorage(',');


-- Charger les données
flights = LOAD 'input/flights/sample_flights.csv' 
    USING PigStorage(',') 
    AS (
        year:int, month:int, day:int, day_of_week:int,
        dep_time:int, crs_dep_time:int, arr_time:int, crs_arr_time:int,
        carrier:chararray, flight_num:int, tail_num:chararray,
        actual_elapsed_time:int, crs_elapsed_time:int, air_time:int,
        arr_delay:int, dep_delay:int,
        origin:chararray, dest:chararray,
        distance:int, taxi_in:int, taxi_out:int,
        cancelled:int, cancellation_code:chararray, diverted:int,
        carrier_delay:int, weather_delay:int, nas_delay:int,
        security_delay:int, late_aircraft_delay:int
    );

-- Filtrer les vols valides
valid_flights = FILTER flights BY cancelled == 0 AND year IS NOT NULL;

-- ============================================
-- PARTIE 1 : Volume par Année et Transporteur
-- ============================================

-- Projection : année et transporteur
carrier_year = FOREACH valid_flights GENERATE year, carrier;

-- Grouper par (année, transporteur)
carrier_grouped = GROUP carrier_year BY (year, carrier);

-- Calculer le volume et le log
carrier_volume = FOREACH carrier_grouped GENERATE 
    FLATTEN(group) AS (year, carrier),
    COUNT(carrier_year) AS flight_count,
    LOG10((double)COUNT(carrier_year)) AS log_volume;

-- Trier par année et volume
sorted_carrier_volume = ORDER carrier_volume BY year, flight_count DESC;

-- Afficher
DUMP sorted_carrier_volume;

-- Sauvegarder
STORE sorted_carrier_volume INTO 'pigout/flights/carrier_volume_by_year' USING PigStorage(',');

-- ============================================
-- PARTIE 2 : Volume Médian par Transporteur
-- ============================================

-- Extraire uniquement transporteur et log_volume
carrier_log = FOREACH carrier_volume GENERATE carrier, log_volume;

-- Grouper par transporteur
carrier_stats = GROUP carrier_log BY carrier;

-- Calculer les statistiques
carrier_median = FOREACH carrier_stats {
    sorted_vol = ORDER carrier_log BY log_volume;
    GENERATE 
        group AS carrier,
        COUNT(carrier_log) AS nb_years,
        AVG(carrier_log.log_volume) AS avg_log_volume,
        MIN(carrier_log.log_volume) AS min_log_volume,
        MAX(carrier_log.log_volume) AS max_log_volume;
}

-- Trier par volume moyen décroissant
sorted_carriers = ORDER carrier_median BY avg_log_volume DESC;

-- Afficher
DUMP sorted_carriers;

-- Sauvegarder
STORE sorted_carriers INTO 'pigout/flights/carrier_popularity' USING PigStorage(',');



 ============================================
-- ANALYSE 3 : Proportion de Vols Retardés
-- ============================================
-- Un vol est retardé si arr_delay > 15 minutes
-- Calcul à différentes granularités temporelles

-- Charger les données
flights = LOAD 'input/flights/sample_flights.csv' 
    USING PigStorage(',') 
    AS (
        year:int, month:int, day:int, day_of_week:int,
        dep_time:int, crs_dep_time:int, arr_time:int, crs_arr_time:int,
        carrier:chararray, flight_num:int, tail_num:chararray,
        actual_elapsed_time:int, crs_elapsed_time:int, air_time:int,
        arr_delay:int, dep_delay:int,
        origin:chararray, dest:chararray,
        distance:int, taxi_in:int, taxi_out:int,
        cancelled:int, cancellation_code:chararray, diverted:int,
        carrier_delay:int, weather_delay:int, nas_delay:int,
        security_delay:int, late_aircraft_delay:int
    );

-- Filtrer les vols valides
valid_flights = FILTER flights BY cancelled == 0 AND year IS NOT NULL;

-- ============================================
-- Ajouter le Statut de Retard
-- ============================================

-- Déterminer si retardé (> 15 minutes)
flights_with_delay_status = FOREACH valid_flights GENERATE 
    year,
    month,
    day,
    day_of_week,
    arr_delay,
    dep_delay,
    (arr_delay IS NOT NULL AND arr_delay > 15 ? 1 : 0) AS is_delayed;

-- ============================================
-- GRANULARITÉ 1 : Par Année
-- ============================================

by_year = GROUP flights_with_delay_status BY year;

delay_by_year = FOREACH by_year GENERATE 
    group AS year,
    COUNT(flights_with_delay_status) AS total_flights,
    SUM(flights_with_delay_status.is_delayed) AS delayed_flights,
    (double)SUM(flights_with_delay_status.is_delayed) / (double)COUNT(flights_with_delay_status) AS delay_proportion;

-- Trier
sorted_delay_year = ORDER delay_by_year BY year;

-- Afficher et sauvegarder
DUMP sorted_delay_year;
STORE sorted_delay_year INTO 'pigout/flights/delays_by_year' USING PigStorage(',');

-- ============================================
-- GRANULARITÉ 2 : Par Mois
-- ============================================

by_month = GROUP flights_with_delay_status BY (year, month);

delay_by_month = FOREACH by_month GENERATE 
    FLATTEN(group) AS (year, month),
    COUNT(flights_with_delay_status) AS total_flights,
    SUM(flights_with_delay_status.is_delayed) AS delayed_flights,
    (double)SUM(flights_with_delay_status.is_delayed) / (double)COUNT(flights_with_delay_status) AS delay_proportion;

-- Trier
sorted_delay_month = ORDER delay_by_month BY year, month;

-- Sauvegarder
STORE sorted_delay_month INTO 'pigout/flights/delays_by_month' USING PigStorage(',');

-- ============================================
-- GRANULARITÉ 3 : Par Jour de la Semaine
-- ============================================

by_day_of_week = GROUP flights_with_delay_status BY day_of_week;

delay_by_dow = FOREACH by_day_of_week GENERATE 
    group AS day_of_week,
    COUNT(flights_with_delay_status) AS total_flights,
    SUM(flights_with_delay_status.is_delayed) AS delayed_flights,
    (double)SUM(flights_with_delay_status.is_delayed) / (double)COUNT(flights_with_delay_status) AS delay_proportion;

-- Trier
sorted_delay_dow = ORDER delay_by_dow BY day_of_week;

-- Afficher et sauvegarder
DUMP sorted_delay_dow;
STORE sorted_delay_dow INTO 'pigout/flights/delays_by_day_of_week' USING PigStorage(',');

-- ============================================
-- GRANULARITÉ 4 : Par Heure du Jour
-- ============================================

-- Extraire l'heure de départ
flights_with_hour = FOREACH valid_flights GENERATE 
    (dep_time IS NOT NULL ? (int)(dep_time / 100) : -1) AS dep_hour,
    (arr_delay IS NOT NULL AND arr_delay > 15 ? 1 : 0) AS is_delayed;

-- Filtrer les heures valides
valid_hours = FILTER flights_with_hour BY dep_hour >= 0 AND dep_hour < 24;

-- Grouper par heure
by_hour = GROUP valid_hours BY dep_hour;

delay_by_hour = FOREACH by_hour GENERATE 
    group AS hour,
    COUNT(valid_hours) AS total_flights,
    SUM(valid_hours.is_delayed) AS delayed_flights,
    (double)SUM(valid_hours.is_delayed) / (double)COUNT(valid_hours) AS delay_proportion;

-- Trier
sorted_delay_hour = ORDER delay_by_hour BY hour;

-- Afficher et sauvegarder
DUMP sorted_delay_hour;
STORE sorted_delay_hour INTO 'pigout/flights/delays_by_hour' USING PigStorage(',');


-- ANALYSE 4 : Retards par Transporteur
-- ============================================
-- Proportion de vols retardés par transporteur
-- À différentes granularités temporelles

-- Charger les données
flights = LOAD 'input/flights/sample_flights.csv' 
    USING PigStorage(',') 
    AS (
        year:int, month:int, day:int, day_of_week:int,
        dep_time:int, crs_dep_time:int, arr_time:int, crs_arr_time:int,
        carrier:chararray, flight_num:int, tail_num:chararray,
        actual_elapsed_time:int, crs_elapsed_time:int, air_time:int,
        arr_delay:int, dep_delay:int,
        origin:chararray, dest:chararray,
        distance:int, taxi_in:int, taxi_out:int,
        cancelled:int, cancellation_code:chararray, diverted:int,
        carrier_delay:int, weather_delay:int, nas_delay:int,
        security_delay:int, late_aircraft_delay:int
    );

-- Filtrer les vols valides
valid_flights = FILTER flights BY cancelled == 0 AND year IS NOT NULL;

-- ============================================
-- Préparer les Données
-- ============================================

-- Statut de retard par transporteur
carrier_delays = FOREACH valid_flights GENERATE 
    carrier,
    year,
    month,
    day_of_week,
    (arr_delay IS NOT NULL AND arr_delay > 15 ? 1 : 0) AS is_delayed;

-- ============================================
-- GRANULARITÉ 1 : Par Transporteur (Global)
-- ============================================

carrier_grouped = GROUP carrier_delays BY carrier;

carrier_delay_total = FOREACH carrier_grouped GENERATE 
    group AS carrier,
    COUNT(carrier_delays) AS total_flights,
    SUM(carrier_delays.is_delayed) AS delayed_flights,
    (double)SUM(carrier_delays.is_delayed) / (double)COUNT(carrier_delays) AS delay_rate;

-- Trier par taux de retard décroissant
sorted_carrier_total = ORDER carrier_delay_total BY delay_rate DESC;

-- Afficher et sauvegarder
DUMP sorted_carrier_total;
STORE sorted_carrier_total INTO 'pigout/flights/carrier_delays_total' USING PigStorage(',');

-- ============================================
-- GRANULARITÉ 2 : Par Transporteur et Année
-- ============================================

carrier_year_grouped = GROUP carrier_delays BY (carrier, year);

carrier_delay_by_year = FOREACH carrier_year_grouped GENERATE 
    FLATTEN(group) AS (carrier, year),
    COUNT(carrier_delays) AS total_flights,
    SUM(carrier_delays.is_delayed) AS delayed_flights,
    (double)SUM(carrier_delays.is_delayed) / (double)COUNT(carrier_delays) AS delay_rate;

-- Trier
sorted_carrier_year = ORDER carrier_delay_by_year BY year, delay_rate DESC;

-- Sauvegarder
STORE sorted_carrier_year INTO 'pigout/flights/carrier_delays_by_year' USING PigStorage(',');

-- ============================================
-- GRANULARITÉ 3 : Par Transporteur et Mois
-- ============================================

carrier_month_grouped = GROUP carrier_delays BY (carrier, year, month);

carrier_delay_by_month = FOREACH carrier_month_grouped GENERATE 
    FLATTEN(group) AS (carrier, year, month),
    COUNT(carrier_delays) AS total_flights,
    SUM(carrier_delays.is_delayed) AS delayed_flights,
    (double)SUM(carrier_delays.is_delayed) / (double)COUNT(carrier_delays) AS delay_rate;

-- Trier
sorted_carrier_month = ORDER carrier_delay_by_month BY year, month, delay_rate DESC;

-- Sauvegarder
STORE sorted_carrier_month INTO 'pigout/flights/carrier_delays_by_month' USING PigStorage(',');

-- ============================================
-- GRANULARITÉ 4 : Par Transporteur et Jour de Semaine
-- ============================================

carrier_dow_grouped = GROUP carrier_delays BY (carrier, day_of_week);

carrier_delay_by_dow = FOREACH carrier_dow_grouped GENERATE 
    FLATTEN(group) AS (carrier, day_of_week),
    COUNT(carrier_delays) AS total_flights,
    SUM(carrier_delays.is_delayed) AS delayed_flights,
    (double)SUM(carrier_delays.is_delayed) / (double)COUNT(carrier_delays) AS delay_rate;

-- Trier
sorted_carrier_dow = ORDER carrier_delay_by_dow BY day_of_week, delay_rate DESC;

-- Sauvegarder
STORE sorted_carrier_dow INTO 'pigout/flights/carrier_delays_by_dow' USING PigStorage(',');

-- ============================================
-- Top 10 Transporteurs avec le Plus de Retards
-- ============================================

top10_worst_carriers = LIMIT sorted_carrier_total 10;

-- Afficher
DUMP top10_worst_carriers;



-- ANALYSE 5 : Itinéraires les Plus Fréquentés
-- ============================================
-- Paires d'aéroports non ordonnées (i, j)
-- Tableau de fréquences des routes

-- Charger les données
flights = LOAD 'input/flights/sample_flights.csv' 
    USING PigStorage(',') 
    AS (
        year:int, month:int, day:int, day_of_week:int,
        dep_time:int, crs_dep_time:int, arr_time:int, crs_arr_time:int,
        carrier:chararray, flight_num:int, tail_num:chararray,
        actual_elapsed_time:int, crs_elapsed_time:int, air_time:int,
        arr_delay:int, dep_delay:int,
        origin:chararray, dest:chararray,
        distance:int, taxi_in:int, taxi_out:int,
        cancelled:int, cancellation_code:chararray, diverted:int,
        carrier_delay:int, weather_delay:int, nas_delay:int,
        security_delay:int, late_aircraft_delay:int
    );

-- Filtrer les vols valides
valid_flights = FILTER flights BY cancelled == 0 AND year IS NOT NULL;

-- ============================================
-- PARTIE 1 : Routes Non Ordonnées
-- ============================================

-- Créer des paires d'aéroports non ordonnées
-- (i, j) où i < j alphabétiquement
routes = FOREACH valid_flights GENERATE 
    (origin < dest ? origin : dest) AS airport1,
    (origin < dest ? dest : origin) AS airport2,
    origin,
    dest,
    distance;

-- Grouper par paire d'aéroports
routes_grouped = GROUP routes BY (airport1, airport2);

-- Compter le nombre de vols par route
route_frequencies = FOREACH routes_grouped GENERATE 
    FLATTEN(group) AS (airport1, airport2),
    COUNT(routes) AS flight_count,
    AVG(routes.distance) AS avg_distance;

-- Trier par fréquence décroissante
sorted_routes = ORDER route_frequencies BY flight_count DESC;

-- Top 20 itinéraires
top20_routes = LIMIT sorted_routes 20;

-- Afficher
DUMP top20_routes;

-- Sauvegarder
STORE top20_routes INTO 'pigout/flights/popular_routes' USING PigStorage(',');

-- ============================================
-- PARTIE 2 : Routes Ordonnées (Origine → Destination)
-- ============================================

-- Routes directionnelles
directional_routes = FOREACH valid_flights GENERATE 
    origin,
    dest,
    distance;

-- Grouper
dir_routes_grouped = GROUP directional_routes BY (origin, dest);

-- Compter
dir_route_frequencies = FOREACH dir_routes_grouped GENERATE 
    FLATTEN(group) AS (origin, dest),
    COUNT(directional_routes) AS flight_count,
    AVG(directional_routes.distance) AS avg_distance;

-- Trier
sorted_dir_routes = ORDER dir_route_frequencies BY flight_count DESC;

-- Top 20 routes directionnelles
top20_dir_routes = LIMIT sorted_dir_routes 20;

-- Afficher et sauvegarder
DUMP top20_dir_routes;
STORE top20_dir_routes INTO 'pigout/flights/popular_directional_routes' USING PigStorage(',');

-- ============================================
-- PARTIE 3 : Routes par Transporteur
-- ============================================

-- Routes avec transporteur
carrier_routes = FOREACH valid_flights GENERATE 
    carrier,
    origin,
    dest;

-- Grouper par (transporteur, origine, destination)
carrier_routes_grouped = GROUP carrier_routes BY (carrier, origin, dest);

-- Compter
carrier_route_freq = FOREACH carrier_routes_grouped GENERATE 
    FLATTEN(group) AS (carrier, origin, dest),
    COUNT(carrier_routes) AS flight_count;

-- Trier
sorted_carrier_routes = ORDER carrier_route_freq BY flight_count DESC;

-- Top 20 routes par transporteur
top20_carrier_routes = LIMIT sorted_carrier_routes 20;

-- Afficher et sauvegarder
DUMP top20_carrier_routes;
STORE top20_carrier_routes INTO 'pigout/flights/popular_carrier_routes' USING PigStorage(',');

-- ============================================
-- PARTIE 4 : Routes les Plus Longues
-- ============================================

-- Routes avec distance
routes_with_distance = FOREACH valid_flights GENERATE 
    origin,
    dest,
    distance;

-- Dédupliquer
routes_unique = DISTINCT routes_with_distance;

-- Trier par distance
sorted_by_distance = ORDER routes_unique BY distance DESC;

-- Top 20 routes les plus longues
top20_longest = LIMIT sorted_by_distance 20;

-- Afficher et sauvegarder
DUMP top20_longest;
STORE top20_longest INTO 'pigout/flights/longest_routes' USING PigStorage(',');